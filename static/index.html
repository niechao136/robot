<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>AI智能数字模拟面试机器人</title>
<style>
    html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        font-family: '楷体', KaiTi, serif;
        background-size: cover;
        color: white;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
    }

    h1 { margin-top: 20px; }

    #wrapperPlayer {
        height: 480px;
        width: 1270px;
        background-color: aqua;
        margin: 20px auto;
    }

    #userSendArea {
        margin: 20px auto;
    }

    #chatInput {
        width: 300px;
        height: 40px;
        font-size: 16px;
        margin-right: 10px;
    }

    button {
        width: 120px;
        height: 46px;
        margin: 5px;
        cursor: pointer;
    }

    .responseText {
        border: 1px solid #ccc;
        padding: 10px;
        margin: 10px auto;
        width: 60%;
        background-color: rgba(0,0,0,0.6);
        border-radius: 8px;
        color: white;
    }
</style>
<script type="module" src="xrtc-player-BJTnVhG9.js"></script>
<script type="module" src="webrtc-player--YuOiwFd.js"></script>
<script type="module" src="index-OS7Lza_r.js"></script>
</head>
<body>
<h1>欢迎来到智泊AI数字人模拟面试现场</h1>
<div id="wrapperPlayer"></div>
<div id="buttonArea"></div>
<div id="responseArea"></div>
<div id="userSendArea"></div>

<script type="module">
    import { A as AvatarPlatform } from "./index-OS7Lza_r.js"
    const InitAppInfo = {
        serverUrl: 'wss://avatar.cn-huadong-1.xf-yun.com/v1/interact',
        appId: 'e06eba7a',
        apiKey: '27e470270cd753fe0cd38c52c369c894',
        apiSecret: 'MjBiYjJiOTdkNjU3M2RhMmUzYWQyNGNk',
        sceneId: '217164690583851008',
    }
    const globalInfo = {
        stream: { protocol: 'xrtc', alpha: 1 },
        avatar: { avatar_id: '138805001' },
        tts: { vcn: 'x4_yuexiaoni_assist' }
    }
    const SDKEvents = {
        connected: 'connected',
        disconnected: 'disconnected',
        nlp: 'nlp',
        asr: 'asr',
        stream_start: 'stream_start',
        frame_start: 'frame_start',
        frame_stop: 'frame_stop',
        action_start: 'action_start',
        action_stop: 'action_stop',
        tts_duration: 'tts_duration',
        subtitle_info: 'subtitle_info',
        error: 'error',
    }
    const PlayerEvents = {
        play: 'play',
        waiting: 'waiting',
        playing: 'playing',
        stop: 'stop',
        playNotAllowed: 'not-allowed',
        error: 'error',
    }
    let avatarPlatform;

    function createElement(tag, props = {}, parent = document.body) {
        const el = document.createElement(tag);
        Object.assign(el, props);
        parent.appendChild(el);
        return el;
    }

    async function chatWithAI() {
        const chatInput = document.getElementById('chatInput');
        const query = chatInput.value.trim();
        if (!query) return;

        try {
            const res = await fetch("https://150.109.15.178:10082/chat", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({query})
            });
            const data = await res.json();
            const msg = Array.isArray(data) && data[0]?.msg ? data[0].msg : "抱歉，暂时无法回答";
            avatarPlatform.writeText(msg, { nlp: false });
            document.getElementById('responseArea').innerHTML = `<div class="responseText">${msg}</div>`;
            chatInput.value = "";
        } catch (err) {
            console.error(err);
            document.getElementById('responseArea').innerHTML = `<div class="responseText">服务暂时不可用，请稍后再试。</div>`;
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        avatarPlatform = new AvatarPlatform();
        avatarPlatform.setApiInfo(InitAppInfo);
        avatarPlatform.setGlobalParams(globalInfo);

        const buttonArea = document.getElementById('buttonArea');
        const startBtn = createElement('button', {innerText: '开始面试'}, buttonArea);
        const endBtn = createElement('button', {innerText: '结束面试', disabled: true}, buttonArea);

        startBtn.addEventListener('click', async () => {
            await avatarPlatform.start({wrapper: document.querySelector('#wrapperPlayer')});
            const player = avatarPlatform.player || avatarPlatform.createPlayer();
            player.resume && player.resume();
            const userArea = document.getElementById('userSendArea');
            if (!document.getElementById('chatInput')) {
                createElement('input', {id:'chatInput', placeholder:'请输入问题'}, userArea);
                const sendBtn = createElement('button', {innerText:'发送'}, userArea);
                sendBtn.addEventListener('click', chatWithAI);
                document.getElementById('chatInput').addEventListener('keypress', e => { if(e.key==='Enter') chatWithAI(); });
            }
            startBtn.disabled = true;
            endBtn.disabled = false;
        });

        endBtn.addEventListener('click', async () => {
            if (avatarPlatform) {
                try {
                    await avatarPlatform.stop(); // 停止虚拟人会话
                } catch (err) {
                    console.error('结束面试时出错:', err);
                }
            }
            document.getElementById('responseArea').innerHTML = `<div class="responseText">面试已结束。</div>`;
            startBtn.disabled = false;
            endBtn.disabled = true;
        });

        avatarPlatform.on(SDKEvents.connected, (initResp) => console.log('connected', initResp))
            .on(SDKEvents.stream_start, () => console.log('stream_start'))
            .on(SDKEvents.error, (error) => console.log('error', error));

        const player = avatarPlatform.player || avatarPlatform.createPlayer();
        player?.on(PlayerEvents.play, () => console.log('player play'));
    });
</script>
</body>
</html>
