<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>AI智能数字模拟面试机器人</title>
<style>
    html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        font-family: '楷体', KaiTi, serif;
        background: url('./img/background.png') no-repeat center center fixed;
        background-size: cover;
        color: white;
        text-align: center;
    }

    h1 { margin-top: 20px; }

    video, audio {
        width: 65%;
        max-width: 800px;
        height: auto;
        border: 5px solid #333;
        border-radius: 15px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        margin: 20px auto;
        display: block;
    }

    #userSendArea {
        margin: 20px auto;
    }

    #chatInput {
        width: 300px;
        height: 40px;
        font-size: 16px;
        margin-right: 10px;
    }

    #voiceSelect {
        width: 150px;
        height: 46px;
        margin-right: 10px;
    }

    button {
        width: 100px;
        height: 46px;
        cursor: pointer;
    }

    .responseText {
        border: 1px solid #ccc;
        padding: 10px;
        margin: 10px auto;
        width: 60%;
        background-color: rgba(0,0,0,0.6);
        border-radius: 8px;
        color: white;
    }

    #connectionStatus {
        margin-top: 10px;
        font-weight: bold;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk@latest/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle-min.js"></script>
</head>
<body>
<h1>欢迎来到智泊AI数字人模拟面试现场</h1>
<div id="connectionStatus">连接状态: 未连接</div>
<div id="responseArea"></div>
<div id="userSendArea"></div>

<script>
let SpeechSDK = window.SpeechSDK;
let peerConnection;
let avatarSynthesizer;

const cogSvcRegion = "eastus";
const subscriptionKey = "4Bnr4BTLCl1teBJJ2OxCmDlHrXCUDlloHGWQMBnc3rbAFapoujcWJQQJ99BHACYeBjFXJ3w3AAAYACOG7q9j"; // ⚠️安全考虑：前端不建议直接暴露

// 创建元素工具函数
function createElement(tag, props = {}, parent = document.body) {
    const el = document.createElement(tag);
    Object.assign(el, props);
    parent.appendChild(el);
    return el;
}

// 更新连接状态
function updateConnectionStatus(status) {
    const statusEl = document.getElementById('connectionStatus');
    statusEl.textContent = '连接状态: ' + status;
}

// 初始化 WebRTC 连接
async function initPeerConnection(tokenData) {
    peerConnection = new RTCPeerConnection({
        iceServers: [{
            urls: [tokenData.Urls[0]],
            username: tokenData.Username,
            credential: tokenData.Password
        }]
    });

    peerConnection.onconnectionstatechange = () => updateConnectionStatus(peerConnection.connectionState);

    peerConnection.ontrack = event => {
        const stream = event.streams[0];
        if(event.track.kind === 'video') {
            let video = document.getElementById('videoPlayer');
            if(!video) video = createElement('video', {id:'videoPlayer', autoplay:true, playsInline:true});
            video.srcObject = stream;
        }
        if(event.track.kind === 'audio') {
            let audio = document.getElementById('audioPlayer');
            if(!audio) audio = createElement('audio', {id:'audioPlayer', autoplay:true});
            audio.srcObject = stream;
        }
    };

    // 创建收发器
    peerConnection.addTransceiver("video", {direction: "sendrecv"});
    peerConnection.addTransceiver("audio", {direction: "sendrecv"});
}

// AI TTS 语音合成
function speakText(msg, style = 'default') {
    const voice = document.getElementById('voiceSelect').value;
    const ssml = `<speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xmlns:mstts='http://www.w3.org/2001/mstts' xml:lang='zh-CN'>
        <voice name='${voice}'>
            <mstts:express-as style='${style}' styledegree='2'>${msg}</mstts:express-as>
        </voice>
    </speak>`;

    avatarSynthesizer.speakSsmlAsync(ssml)
        .then(r => console.log("speakSsmlAsync result:", r))
        .catch(e => console.error("speakSsmlAsync failed:", e));
}

// AI 聊天
async function chatWithAI() {
    const chatInput = document.getElementById('chatInput');
    const query = chatInput.value.trim();
    if(!query) return;

    try {
        const res = await fetch("https://150.109.15.178:10082/chat", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({query})
        });
        const data = await res.json();

        const msg = Array.isArray(data) && data[0]?.msg ? data[0].msg : "抱歉，暂时无法回答";
        const qingxu = Array.isArray(data) && data[0]?.qingxu ? data[0].qingxu : "default";

        speakText(msg, qingxu);

        const responseArea = document.getElementById('responseArea');
        responseArea.innerHTML = `<div class="responseText">${msg}</div>`;

        chatInput.value = "";
    } catch (err) {
        console.error(err);
        const responseArea = document.getElementById('responseArea');
        responseArea.innerHTML = `<div class="responseText">服务暂时不可用，请稍后再试。</div>`;
    }
}

// 页面初始化
document.addEventListener('DOMContentLoaded', async () => {
    // 创建输入区域
    const userArea = document.getElementById('userSendArea');
    createElement('input', {id:'chatInput', placeholder:'请输入问题'}, userArea);
    createElement('select', {id:'voiceSelect', innerHTML:`
        <option value="zh-CN-XiaomoNeural" selected>普通话</option>
        <option value="zh-HK-HiuMaanNeural">粤语</option>
        <option value="zh-TW-HsiaoChenNeural">台湾</option>
    `}, userArea);
    const sendBtn = createElement('button', {innerText:'发送'}, userArea);
    sendBtn.addEventListener('click', chatWithAI);
    document.getElementById('chatInput').addEventListener('keypress', e => { if(e.key==='Enter') chatWithAI(); });

    // 获取 token 并初始化连接
    try {
        const tokenRes = await fetch(`https://${cogSvcRegion}.tts.speech.microsoft.com/cognitiveservices/avatar/relay/token/v1`, {
            headers: {"Ocp-Apim-Subscription-Key": subscriptionKey}
        });
        const tokenData = await tokenRes.json();
        await initPeerConnection(tokenData);

        // 初始化 AvatarSynthesizer
        const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(subscriptionKey, cogSvcRegion);
        const videoFormat = new SpeechSDK.AvatarVideoFormat();
        const avatarConfig = new SpeechSDK.AvatarConfig("lisa", "casual-sitting", videoFormat);
        avatarSynthesizer = new SpeechSDK.AvatarSynthesizer(speechConfig, avatarConfig);
        await avatarSynthesizer.startAvatarAsync(peerConnection);
    } catch(err) {
        console.error('初始化失败:', err);
        updateConnectionStatus('初始化失败');
    }
});
</script>
</body>
</html>
